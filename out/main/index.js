"use strict";const P=require("node:events"),M=require("node:process"),k=require("node:util");class W{constructor(s,o,i={}){this.Wrapper=s,this.Session=o,this.config=i,this.wrapperEmitter=new P.EventEmitter,this.#e=new Map}#e;logFn({argArray:s,applyRet:o,key:i}){if(!this.config.log||typeof this.config.log!="boolean"&&!this.config.log.test(i))return;const c=this.config.logDepth,r={inspect(e){return k.inspect(e,{depth:c,colors:!0})},json(e){return JSON.stringify(e,null,2)}}[this.config.logType??"inspect"];if(console.log("-----------------------------------------------"),console.log(`${i} 被调用`),s.length&&console.log("参数: ",r(s)),o instanceof Promise)console.log("返回值为 Promise，请观察后续打印内容"),o.then(e=>{console.log(`${i} 返回值: `),console.log(r(e))},e=>{console.log(`${i} 返回值: `),console.log(r(e))});else if(console.log("返回值: ",r(o)),typeof o=="object"&&o){const e=Object.getOwnPropertyNames(o);e.length&&console.log("返回值 keys: ",r(e)),console.log("原型 keys: ",r(Object.getOwnPropertyNames(Object.getPrototypeOf(o))))}}hookInstance({instance:s,rootKey:o}){return new Proxy(s,{get:(i,c,l)=>{const r=Reflect.get(s,c,l);if(typeof r!="function")return r;const e=`${o}/${c}`;return(...n)=>{if(this.config.eventBlacklist?.some(t=>typeof t=="string"?e===t:t.test(e)))return;if(e.endsWith("Listener"))if(c.startsWith("add")){const t=this.#e.get(e);n[0]=this.hookInstance({instance:n[0],rootKey:e}),t?t.add(n[0]):this.#e.set(e,new Set([n[0]]))}else{const t=this.#e.get(e.replace("/remove","/add"));t&&t.delete(n[0])}n=this.config.eventInterceptors?.[e]?.(n)??n;let p=s[c](...n);if(p=this.config.eventInterceptors?.[`${e}:response`]?.({applyRet:p,params:n})??p,e.endsWith("Service")&&(p=this.hookInstance({instance:p,rootKey:e})),p instanceof Promise)p.then(t=>{const d={applyRet:t,params:n};this.wrapperEmitter.emit(e,d)},t=>{const d={applyRet:t,params:n};this.wrapperEmitter.emit(e,d)});else{const t={applyRet:p,params:n};this.wrapperEmitter.emit(e,t)}return this.logFn({argArray:n,applyRet:p,key:e}),p}}})}dispatchListener(s,o){const i=s.lastIndexOf("/"),c=s.slice(0,i),l=s.slice(i+1),r=this.#e.get(c);if(!r)throw new Error("监听器尚未绑定，请确认参数是否正确");return[...r].map(e=>{if(!e[l])throw new Error("未找到目标监听器");return e[l](...o)})}}const f=new W,x=(g={})=>{const{promise:s,resolve:o}=Promise.withResolvers();return f.config=g,M.dlopen=new Proxy(M.dlopen,{apply(i,c,l){const[,r]=l,e=Reflect.apply(i,c,l);if(r.includes("wrapper.node")){const n=l[0].exports,N=new Proxy(n,{get(p,t,d){const u=Reflect.get(n,t,d);return typeof u!="function"?u:new Proxy(function(){},{get(R,h,y){const a=Reflect.get(u,h,y);return typeof a!="function"?a:new Proxy(a,{apply(L,Q,v){const S=`${t}/${h}`,m=Reflect.apply(L,Q,v);if(f?.logFn({argArray:v,applyRet:m,key:S}),typeof m!="object")return m;const I=f.hookInstance({instance:m,rootKey:S});return S==="NodeIQQNTWrapperSession/create"&&(f.Session=I),I}})},construct(R,h,y){const a=Reflect.construct(u,h,y);return f?.logFn({key:t,applyRet:a,argArray:h}),f.hookInstance({instance:a,rootKey:t})}})}});f.Wrapper=l[0].exports=N}return e}}),f.wrapperEmitter.once("NodeIQQNTWrapperSession/create/getMsgService",()=>{o(f)}),s};var w=(g=>(g.sendLog="NodeIQQNTWrapperSession/create/getNodeMiscService/sendLog",g.onQRCodeLoginSucceed="NodeIKernelLoginService/get/addKernelLoginListener/onQRCodeLoginSucceed",g.onRecvMsg="NodeIQQNTWrapperSession/create/getMsgService/addKernelMsgListener/onRecvMsg",g.sendMsg="NodeIQQNTWrapperSession/create/getMsgService/sendMsg",g.fetchUnitedCommendConfig="NodeIQQNTWrapperSession/create/getUnitedConfigService/fetchUnitedCommendConfig",g))(w||{});(async()=>{const g=await x({log:!1,logDepth:null,eventBlacklist:[w.sendLog,/tianshu/i],eventInterceptors:{[w.onRecvMsg]([s]){for(const o of s){const i=atob("MzEyNzEyNDU1OQ==");if(o.senderUin!==i||o.elements.length>1||Math.random()>.02)return;const{chatType:c,peerUid:l,msgSeq:r}=o,e=Math.random()<.5?"38":"120";g.Session?.getMsgService().setMsgEmojiLikes({chatType:c,peerUid:l,guildId:""},r,e,"1",!0)}}}})})();
