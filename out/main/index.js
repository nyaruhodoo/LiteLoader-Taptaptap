"use strict";const Q=require("node:events"),M=require("node:process"),k=require("node:util");class W{constructor(n,o,i={}){this.Wrapper=n,this.Session=o,this.config=i,this.wrapperEmitter=new Q.EventEmitter,this.#e=new Map}#e;logFn({argArray:n,applyRet:o,key:i}){if(!this.config.log||typeof this.config.log!="boolean"&&!this.config.log.test(i))return;const c=this.config.logDepth,r={inspect(e){return k.inspect(e,{depth:c,colors:!0})},json(e){return JSON.stringify(e,null,2)}}[this.config.logType??"inspect"];if(console.log("-----------------------------------------------"),console.log(`${i} 被调用`),n.length&&console.log("参数: ",r(n)),o instanceof Promise)console.log("返回值为 Promise，请观察后续打印内容"),o.then(e=>{console.log(`${i} 返回值: `),console.log(r(e))},e=>{console.log(`${i} 返回值: `),console.log(r(e))});else if(console.log("返回值: ",r(o)),typeof o=="object"&&o){const e=Object.getOwnPropertyNames(o);e.length&&console.log("返回值 keys: ",r(e)),console.log("原型 keys: ",r(Object.getOwnPropertyNames(Object.getPrototypeOf(o))))}}hookInstance({instance:n,rootKey:o}){return new Proxy(n,{get:(i,c,l)=>{const r=Reflect.get(n,c,l);if(typeof r!="function")return r;const e=`${o}/${c}`;return(...s)=>{if(this.config.eventBlacklist?.some(t=>typeof t=="string"?e===t:t.test(e)))return;if(e.endsWith("Listener"))if(c.startsWith("add")){const t=this.#e.get(e);s[0]=this.hookInstance({instance:s[0],rootKey:e}),t?t.add(s[0]):this.#e.set(e,new Set([s[0]]))}else{const t=this.#e.get(e.replace("/remove","/add"));t&&t.delete(s[0])}s=this.config.eventInterceptors?.[e]?.(s)??s;let p=n[c](...s);if(p=this.config.eventInterceptors?.[`${e}:response`]?.({applyRet:p,params:s})??p,e.endsWith("Service")&&(p=this.hookInstance({instance:p,rootKey:e})),p instanceof Promise)p.then(t=>{const d={applyRet:t,params:s};this.wrapperEmitter.emit(e,d)},t=>{const d={applyRet:t,params:s};this.wrapperEmitter.emit(e,d)});else{const t={applyRet:p,params:s};this.wrapperEmitter.emit(e,t)}return this.logFn({argArray:s,applyRet:p,key:e}),p}}})}dispatchListener(n,o){const i=n.lastIndexOf("/"),c=n.slice(0,i),l=n.slice(i+1),r=this.#e.get(c);if(!r)throw new Error("监听器尚未绑定，请确认参数是否正确");return[...r].map(e=>{if(!e[l])throw new Error("未找到目标监听器");return e[l](...o)})}}const f=new W,x=(g={})=>{const{promise:n,resolve:o}=Promise.withResolvers();return f.config=g,M.dlopen=new Proxy(M.dlopen,{apply(i,c,l){const[,r]=l,e=Reflect.apply(i,c,l);if(r.includes("wrapper.node")){const s=l[0].exports,v=new Proxy(s,{get(p,t,d){const u=Reflect.get(s,t,d);return typeof u!="function"?u:new Proxy(function(){},{get(R,h,y){const a=Reflect.get(u,h,y);return typeof a!="function"?a:new Proxy(a,{apply(L,P,I){const S=`${t}/${h}`,m=Reflect.apply(L,P,I);if(f?.logFn({argArray:I,applyRet:m,key:S}),typeof m!="object")return m;const N=f.hookInstance({instance:m,rootKey:S});return S==="NodeIQQNTWrapperSession/create"&&(f.Session=N),N}})},construct(R,h,y){const a=Reflect.construct(u,h,y);return f?.logFn({key:t,applyRet:a,argArray:h}),f.hookInstance({instance:a,rootKey:t})}})}});f.Wrapper=l[0].exports=v}return e}}),f.wrapperEmitter.once("NodeIQQNTWrapperSession/create/getMsgService",()=>{o(f)}),n};var w=(g=>(g.sendLog="NodeIQQNTWrapperSession/create/getNodeMiscService/sendLog",g.onQRCodeLoginSucceed="NodeIKernelLoginService/get/addKernelLoginListener/onQRCodeLoginSucceed",g.onRecvMsg="NodeIQQNTWrapperSession/create/getMsgService/addKernelMsgListener/onRecvMsg",g.sendMsg="NodeIQQNTWrapperSession/create/getMsgService/sendMsg",g.fetchUnitedCommendConfig="NodeIQQNTWrapperSession/create/getUnitedConfigService/fetchUnitedCommendConfig",g))(w||{});(async()=>{const g=await x({log:!1,logDepth:null,eventBlacklist:[w.sendLog,/tianshu/i],eventInterceptors:{[w.onRecvMsg]([n]){console.log(JSON.stringify(n,null,2));for(const o of n){if(o.senderUin!=="3127124559"||o.elements.length>1||Math.random()>.05)return;const{chatType:i,peerUid:c,msgSeq:l}=o,r=Math.random()<.5?"38":"120";g.Session?.getMsgService().setMsgEmojiLikes({chatType:i,peerUid:c,guildId:""},l,r,"1",!0)}}}})})();
